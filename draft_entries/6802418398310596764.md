---
Title: private-isuをPHP実装で解いた (50万点)
EditURL: https://blog.hatena.ne.jp/stefafafan/stefafafan.hatenablog.com/atom/entry/6802418398310596764
PreviewURL: https://blog.stenyan.jp/draft/entry/imYtmc2krK0ZSA082FvI-fcdMLQ
Draft: true
---

先日はISUCON14に参加しましたが、その直前まで素振りがてら [https://github.com/catatsuy/private-isu:title=catatsuy/private-isu] をPHPで解いていました。普段ISUCONはGoで参加してますが、何気なくPHPで解く場合の難しさや何点くらい出すことができるのか？というところが気になってやってみたのでその結果を共有します。

以下のリポジトリに細かく作業内容を反映しているので参考にしていただけたら幸いです。この記事ではPHPでISUCONを解く際に参考になりそうなポイントをハイライトします。

[https://github.com/stefafafan/private-isu-php:embed]

[:contents]

** デプロイ
今回私は <code>rsync</code> で <code>webapp/php</code> ディレクトリを丸ごとデプロイするという方式を取りました((他チームがこういう方式でデプロイしているというのを聞いて今回初めて試しました))。

GitHubにあげているコードは <code>.gitignore</code> に <code>vendor</code> 含めているので、GitHubからpullしてアプリケーションを動かしたい場合は毎回 <code>composer install</code> が必要になります。手元の環境で既に <code>composer install</code> が済んでいる場合は <code>rsync</code> で丸ごとデプロイするだけで済むのが今回の形式の利点でした。

[https://github.com/stefafafan/private-isu-php/blob/main/Makefile:title=Makefile]に以下のコードを記載することで、 <code>make deploy-app</code> を実行するだけでアプリケーションをデプロイできるようにしました。

>|makefile|
deploy-app:
	rsync -av webapp/php/ isu01:~/private_isu/webapp/php/
||<

** プロファイリング
今回はオーソドックスに [https://github.com/tkuchiki/alp:title=tkuchiki/alp] と [https://docs.percona.com/percona-toolkit/pt-query-digest.html:title=pt-query-digest] で遅いエンドポイントや遅いクエリを分析しました。

ただし、Go言語でISUCONに挑戦する際に活用してきた [https://pkg.go.dev/net/http/pprof:title=pprof] による [https://github.com/brendangregg/FlameGraph:title=Flamegraph] を利用したアプリケーションの負荷の可視化と同じようなものが使いたくて調査しました。

参考にした資料一覧:
- [https://speakerdeck.com/uzulla/purohuairujie-guo-falseke-shi-hua-san-ben-sheng-fu-in-php:title=プロファイル結果の可視化三本勝負 in PHP - Speaker Deck]
- [https://speakerdeck.com/sji/shi-jian-woqi-nisezupu-tong-nikanningumositutu-isucon12-ben-xuan-wen-ti-wo-php-deyatutemiru:title=時間を気にせず普通にカンニングもしつつ ISUCON12 本選問題を PHP でやってみる - Speaker Deck]
- [https://www.infiniteloop.co.jp/tech-blog/2023/03/profiling-php8-using-reli/:title=Reli を使った PHP 7.x/8.x サービスの計測｜技術ブログ｜北海道札幌市・宮城県仙台市のVR・ゲーム・システム開発 インフィニットループ]

はじめは [https://www.php.net/manual/ja/book.xhprof.php:title=xhprof] を使う方式を検討して少し試していましたが、最終的に [https://github.com/reliforp/reli-prof:title=Reli] を使うことにしました。

Reliの利点はアプリケーションコードに手を入れずに使えることです。Go言語のpprofを使う場合は毎回アプリケーションコードに手を入れていたことを考えると、Reliはあまりにも便利で驚きました。PHPerの方はぜひ使ってみてほしいと思っています。

** 設定ファイルの確認・ログ出力

** <code>PDO::ATTR_PERSISTENT</code> や composer autoloader optimize の設定

** JITの有効化

** PHP 8.4へのバージョンアップ

** PHP-FPMを捨ててRoadRunnerへ (移行失敗)

** PHP周り以外の改善

** 感想
