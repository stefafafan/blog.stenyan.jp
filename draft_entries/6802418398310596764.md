---
Title: private-isuをPHP実装で解いた (50万点)
Category:
- 技術
EditURL: https://blog.hatena.ne.jp/stefafafan/stefafafan.hatenablog.com/atom/entry/6802418398310596764
PreviewURL: https://blog.stenyan.jp/draft/entry/imYtmc2krK0ZSA082FvI-fcdMLQ
Draft: true
---

先日はISUCON14に参加しましたが、その直前まで素振りがてら [https://github.com/catatsuy/private-isu:title=catatsuy/private-isu] をPHPで解きました。普段ISUCONはGoで参加してますが、最近ISUCONの他言語での解放を試してみたくなり、今回はPHPで挑戦してみました。

private-isuやISUCONをPHPで解く際のポイントをまとめてみました。参考にしていただけたら幸いです。なお、実際のコードと作業ログは詳細に以下のリポジトリにまとめてあります。

[https://github.com/stefafafan/private-isu-php:embed]

[:contents]

** デプロイ
今回は <code>rsync</code> で <code>webapp/php</code> ディレクトリを丸ごとデプロイするという方式を取りました((他チームがこういう方式でデプロイしているというのを聞いて初めて試してみました))。

GitHubにあげているコードは <code>.gitignore</code> に <code>vendor</code> 含めているので、GitHubからpullしてアプリケーションを動かしたい場合は毎回 <code>composer install</code> が必要になります。 <code>rsync</code> でデプロイする場合は手元の環境で既に <code>composer install</code> が済んでいればあとは丸ごとデプロイするだけなのが今回の利点でした。

[https://github.com/stefafafan/private-isu-php/blob/main/Makefile:title=Makefile]に以下のコードを記載することで、 <code>make deploy-app</code> を実行するだけでアプリケーションをデプロイできるようにしました。

>|makefile|
deploy-app:
	rsync -av webapp/php/ isu01:~/private_isu/webapp/php/
||<

** プロファイリング
今回はオーソドックスに [https://github.com/tkuchiki/alp:title=tkuchiki/alp] と [https://docs.percona.com/percona-toolkit/pt-query-digest.html:title=pt-query-digest] で遅いエンドポイントや遅いクエリを分析しました。

ただし、Go言語でISUCONに挑戦する際に活用してきた [https://pkg.go.dev/net/http/pprof:title=pprof] による [https://github.com/brendangregg/FlameGraph:title=Flamegraph] を利用したアプリケーションの負荷の可視化と同じようなものが使いたくて調査しました。

参考にした資料一覧:
- [https://speakerdeck.com/uzulla/purohuairujie-guo-falseke-shi-hua-san-ben-sheng-fu-in-php:title=プロファイル結果の可視化三本勝負 in PHP - Speaker Deck]
- [https://speakerdeck.com/sji/shi-jian-woqi-nisezupu-tong-nikanningumositutu-isucon12-ben-xuan-wen-ti-wo-php-deyatutemiru:title=時間を気にせず普通にカンニングもしつつ ISUCON12 本選問題を PHP でやってみる - Speaker Deck]
- [https://www.infiniteloop.co.jp/tech-blog/2023/03/profiling-php8-using-reli/:title=Reli を使った PHP 7.x/8.x サービスの計測｜技術ブログ｜北海道札幌市・宮城県仙台市のVR・ゲーム・システム開発 インフィニットループ]

はじめは [https://www.php.net/manual/ja/book.xhprof.php:title=xhprof] を使う方式を検討して少し試していましたが、最終的に [https://github.com/reliforp/reli-prof:title=Reli] を使うことにしました。

Reliの利点はアプリケーションコードに手を入れずに使えることです。Go言語のpprofを使う場合は毎回アプリケーションコードに手を入れていたことを考えると、Reliはあまりにも便利で驚きました。PHPerの方はぜひ使ってみてほしいと思っています。

*** private-isu で Reli を使う

簡単に private-isu で Reli を使って FlameGraph を出力する方法を紹介します。

まずはインスタンスにReliを入れます。

>|sh|
composer create-project reliforp/reli-prof
cd reli-prof
||<

動いているプロセスの名前を確認しておきます。

>|sh|
$ ps auxfw | grep fpm
root         594  0.0  0.6 209068 23900 ?        Ss   11:31   0:00 php-fpm: master process (/etc/php/8.3/fpm/php-fpm.conf)
isucon      2071  0.1  0.4 209632 19228 ?        S    11:49   0:00  \_ php-fpm: pool www
isucon      2150  0.0  0.4 209632 19332 ?        S    11:49   0:00  \_ php-fpm: pool www
isucon      2181  0.0  0.4 209632 18792 ?        S    11:50   0:00  \_ php-fpm: pool www
isucon      2214  0.0  0.0   7076  2176 pts/0    S+   11:51   0:00              \_ grep fpm
||<

<code>i:daemon</code> というサブコマンドを利用して、ベンチ実行中にトレースを取得します。結果をファイルに保存しておきます。

>|sh|
sudo ./reli i:daemon -P "php-fpm" > traces.log
||<

ベンチマークの実行が終わったら <code>c:flamegraph</code> サブコマンドを利用してFlameGraph形式の結果をsvgファイルに書き出します。

>|sh|
./reli c:flamegraph < traces.log > traces.svg
||<

最後にローカル環境にsvgファイルをダウンロードしてブラウザで開いてみると、FlameGraphが表示されます。

>|sh|
rsync isu01:~/reli-prof/traces.svg ./
||<

** 設定ファイルの確認・アプリケーションエラーログの出力

private-isu のマニュアルでは nginx と <code>php8.3-fpm.service</code> のログを確認することが案内されています。実際触っていると <code>php8.3-fpm.service</code> をみていても正直ほしい情報はそんなに流れてこなくて、基本 nginx のエラーログをみて判断する感じになります。

実は <code>php.ini</code> の設定を追記するとアプリケーションのエラーログを書き出すことができるのでそれはやった把握しておいた方が良さそうでした。
<code>php.ini</code> の場所はアプリケーションの中で <code>phpinfo();</code> を入れておいてブラウザから確認しました (他にも <code>php -i</code> を実行して調べることもできるみたいです)。

<code>/etc/php/8.3/fpm/php.ini</code> にありました。ISUCONのPHP実装ではどうやらPHP-FPMがよく使われているようなので、このへんにiniファイルが置いてあることが多いかもしれません。

設定ファイル内に <code>error_log</code> の設定がコメントアウトされています。どうやらデフォルトではエラーログの出力先は空らしいので、お好きなパスを指定してあげると良いでしょう。

>|diff|
; Log errors to specified file. PHP's default behavior is to leave this value
; empty.
; https://php.net/error-log
; Example:
- ;error_log = php_errors.log
+ error_log = /var/log/php/php_errors.log
||<

** <code>PDO::ATTR_PERSISTENT</code> や composer autoloader optimize の設定

PHP (PDO) ではデータベースへの接続はデフォルトの状態では接続を使い回すようにはなっていないようです。 <code>PDO::ATTR_PERSISTENT</code> を設定しておくと効果があるかもしれません。

>|diff|
    return new PDO(
        "mysql:dbname={$config['db']['database']};host={$config['db']['host']};port={$config['db']['port']};charset=utf8mb4",
        $config['db']['username'],
-        $config['db']['password']
+        $config['db']['password'],
+        array(PDO::ATTR_PERSISTENT => true)
    );
||<

また、 composer の autoloader に対しても最適化をするための設定があるようです。 以下のように <code>"optimize-autoloader": true,</code> を <code>composer.json</code> に追加しておいて、 <code>composer dump-autoload</code> すると少し効果があるかもしれません。

>|diff|
{
+    "optimize-autoloader": true,
    "require": {
        "slim/slim": "^4.7",
        ...
    }
}
||<

** JITの有効化

PHP 8.0 からはJITコンパイラを有効化することでパフォーマンス向上を見込めます。

<code>phpinfo()</code> の出力結果をみると、 JITの設定は <code>opcache</code> の中にあるようで、 <code>opcache</code> は別途設定ファイルがあるようです。

PHP 8.3の場合は <code>/etc/php/8.3/mods-available/opcache.ini</code> に設定ファイルがあるので、以下のような設定を追加するとおそらくJITが有効化されます。

>|diff|
; configuration for php opcache module
; priority=10
zend_extension=opcache.so
+ opcache.enable_cli=1
+ opcache.jit=on
+ opcache.jit_buffer_size=100M
||<

** PHP 8.4へのバージョンアップ

PHP 8.3 + FPM から PHP 8.4 + FPM にアップグレードすることもできます。

参考: [https://php.watch/articles/php-84-install-upgrade-guide-debian-ubuntu:title]

バージョンの上げ方としては、各種パッケージをインストールし、

>|sh|
sudo LC_ALL=C.UTF-8 add-apt-repository ppa:ondrej/php
sudo apt update
sudo apt install php8.4-cli php8.4-fpm php8.4-mysql
||<

php8.3-fpm を停止、 php8.4-fpm を有効化する、

>|sh|
sudo systemctl stop php8.3-fpm.service
sudo systemctl disable php8.3-fpm.service
sudo systemctl start php8.4-fpm.service
sudo systemctl enable php8.4-fpm.service
||<

そしてnginxの接続先を更新して再起動すれば完了です。FPMのプールの設定が <code>/etc/php/8.3/fpm/pool.d/www.conf</code> にあったので 8.3 と 8.4 の差分を確認して揃えます。

>|diff|
- user = www-data
- group = www-data
+ user = isucon
+ group = isucon
...
listen = xxx
||<

再起動します。

>|sh|
sudo systemctl restart php8.4-fpm.service
sudo systemctl restart nginx.service
||<

** PHP-FPMを捨ててRoadRunnerへ (移行失敗)

徐々にPHP-FPMがボトルネックになっていることに気づき、以下のスライドを参考にRoadRunnerへの移行を試みました。

- [https://speakerdeck.com/sji/shi-jian-woqi-nisezupu-tong-nikanningumositutu-isucon12-ben-xuan-wen-ti-wo-php-deyatutemiru:title=時間を気にせず普通にカンニングもしつつ ISUCON12 本選問題を PHP でやってみる - Speaker Deck]

結論としては結構大変で諦めてしまいました……。RoadRunnerへ移行するには以下のステップが必要です。

- RoadRunnerの設定ファイル (<code>rr.yaml</code>) の追加
- RoadRunner向けworkerファイルの追加 (<code>worker.php</code>)
- workerファイルから既存のDI ContainerやRoutesの設定をハンドリングできるようにコードを調整
- Ubuntu上にRoadRunnerをインストールし、systemd向けのユニットファイルを定義 (デーモン化)
- PHP-FPMデーモンの停止・無効化。RoadRunnerの起動・有効化
- nginxの設定で既存のFastCGIからRoadRunnerの設定を参照するように変更

ブラウザ上で "なんとなく" private-isu が RoadRunner 経由で配信され、一見動いている形にすることはできましたが、画像アップロード周りで壊れていたり、複数workerに対応できなかったりしてベンチマーカーを通すことはできていません。以下のPull Requestが試していた様子となります。

[https://github.com/stefafafan/private-isu-php/pull/1:embed]

** 感想
