---
Title: nginxã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’è§£æã—ã¦JSONã‚’è¿”ã™ã ã‘ã®CLIã‚’Rustã§ä½œæˆã—ãŸ
Category:
- æŠ€è¡“
Date: 2024-11-23T17:21:57+09:00
URL: https://blog.stenyan.jp/entry/2024/11/23/172157
EditURL: https://blog.hatena.ne.jp/stefafafan/stefafafan.hatenablog.com/atom/entry/6802418398306141485
---

æœ€è¿‘Rustã§CLIã‚’ä½œã‚‹ã®ã«çªç„¶ãƒãƒã£ã¦ããŸã®ã¨ã€[https://isucon.net/:title=ISUCON] ãŒè¿‘ã¥ã„ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã£ã¦ã€ä»¥ä¸‹ã®CLIã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

[https://github.com/stefafafan/seki:embed:cite]

[:contents]

** ä½¿ã„æ–¹

ç¾çŠ¶ã¯nginxã®log_formatã‚’JSONã¨ã—ãŸä¸Šã§ç‰¹å®šã®ã‚­ãƒ¼ã‚’æŒã£ã¦ã„ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ (ã“ã†ã„ã†æ„Ÿã˜ã®è¨­å®šã‚’ã—ã¦ãŠãğŸ‘‡)

>|nginx|
log_format json escape=json '{'
                            '"time":"$time_iso8601",'
                            '"host":"$remote_addr",'
                            '"method":"$request_method",'
                            '"uri":"$request_uri",'
                            '"status":"$status",'
                            '"body_bytes":"$body_bytes_sent",'
                            '"referer":"$http_referer",'
                            '"ua":"$http_user_agent",'
                            '"request_time":"$request_time",'
                            '"response_time":"$upstream_response_time"'
                            '}';
||<

ã“ã®çŠ¶æ…‹ã§åã‹ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ã€ <code>seki</code> ã«ãƒ‘ã‚¤ãƒ—ã—ã¦é£Ÿã‚ã›ã‚‹ã®ã¿ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã®JSONãŒè¿”ã£ã¦ãã¾ã™ã€‚((ã‚‚ã£ã¨ã“ã†ã„ã†JSONã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã—ã¦ã»ã—ã„ã¿ãŸã„ãªã®ãŒã‚ã£ãŸã‚‰ã„ã¤ã§ã‚‚issueãªã‚Šã§ã‚³ãƒ¡ãƒ³ãƒˆãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼))

>|sh|
$ cat access.log | seki
[
  {
    "method": "GET",
    "uri": "/hello",
    "count": 1,
    "status_code": {
      "status_1xx": 0,
      "status_2xx": 0,
      "status_3xx": 1,
      "status_4xx": 0,
      "status_5xx": 0
    },
    "response_time": {
      "min": 0.0,
      "max": 0.113,
      "avg": 0.113,
      "sum": 0.113,
      "p50": 0.113,
      "p75": 0.113,
      "p90": 0.113,
      "p95": 0.113,
      "p99": 0.113
    }
  }
]
||<

ã“ã®JSONã‚’ã©ã†ä½¿ã†ã‹ã¯ãƒ¦ãƒ¼ã‚¶ã«å§”ã­ã‚‹ã€ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

** æ€æƒ³

[https://github.com/tkuchiki/alp:title=tkuchiki/alp] ã‚„ [https://github.com/matsuu/kataribe:title=matsuu/kataribe] ãªã©ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ãŒä¸–ã®ä¸­ã«ã‚ã‚‹ã®ã§æ–°ãŸã«ä½œã‚‹å¿…è¦ã¯ç‰¹ã«ãªã„ã§ã™ãŒ((è‡ªåˆ†ã§ã‚‚ä½œã£ã¦ã¿ãŸã‹ã£ãŸã®ã§ä½œã£ãŸã®ãŒå¤§ãã„))ã€æ€æƒ³ã¨ã—ã¦ã¯JSONã¨ã—ã¦è¿”ã—ã¦ãŠã‘ã°è‰²ã€…ã¨åŠ å·¥ã—ãŸã‚Šç‹¬è‡ªã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«çµ„ã¿è¾¼ã‚“ã§ã‚ã‚Œã“ã‚Œã—ã‚„ã™ãã†ã§ã¯ãªã„ã‹ï¼Ÿã¨æ€ã£ã¦ä½œã£ã¦ã¿ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ <code>seki</code> è‡ªä½“ãŒäººé–“ã«ã¿ã‚„ã™ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¸ã®å‡ºåŠ›ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒã¤äºˆå®šã¯ãªã„ã§ã™ã€‚

** private-isu ã§ã¡ã‚‡ã£ã¨ä½¿ã£ã¦ã¿ãŸæ§˜å­

å®Ÿéš›ã« [https://github.com/catatsuy/private-isu:title=catatsuy/private-isu] ã§ã‚‚ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚AMIã‚’åˆ©ç”¨ã—ã¦EC2ã‚µãƒ¼ãƒã‚’å»ºã¦ãŸä¸Šã§å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

ã¾ãš <code>seki</code> ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ä»Šå›ã¯ [https://github.com/stefafafan/seki/releases/tag/v0.1.2:title] ã«è¼‰ã£ã¦ã„ã‚‹ curl ã‚’ä½¿ã†æ‰‹é †ã‚’ä½¿ã„ã¾ã™ã€‚

>|sh|
$ curl --proto '=https' --tlsv1.2 -LsSf https://github.com/stefafafan/seki/releases/download/v0.1.2/seki-installer.sh | sh
||<

PATHã‚’é€šã—ãŸã‹ã£ãŸã‚‰ <code>source</code> ã—ã¦ã­ã¨è¨€ã‚ã‚Œã‚‹ã®ã§ã—ã¾ã™ã€‚

>|sh|
$ source $HOME/.cargo/env
||<

nginx.conf ã® <code>log_format</code> ã‚’æ›¸ãæ›ãˆãŸä¸Šã§ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å›ã—ã¾ã™ã€‚çµ‚ã‚ã£ãŸã‚‰æ—©é€Ÿ <code>seki</code> ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

>|sh|
$ sudo cat /var/log/nginx/access.log | seki
||<

ã“ã‚Œã‚’ä½•æ°—ãªãå®Ÿè¡Œã™ã‚‹ã¨çµæœãŒé•·ã™ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ <code>/posts/12667</code> ã¿ãŸã„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ²¢å±±å€‹åˆ¥ã«ãªã‚‰ã‚“ã§ã„ã‚‹ã®ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚

ä¸€æ—¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä¸€è¦§ã‚’ã–ã£ã¨ã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ <code>jq</code> ã‚³ãƒãƒ³ãƒ‰ã§ <code>.uri</code> ã®ã¿æŠ½å‡ºã—ã¾ã™ã€‚

>|sh|
$ sudo cat /var/log/nginx/access.log | seki | jq '.[] | .uri'
"/posts/12667"
"/posts/2005"
"/image/6908.jpg"
"/image/9785.jpg"
"/image/9228.jpg"
"/posts/556"
"/posts/4366"
"/image/1149.jpg"
"/posts/7523"
"/posts/5208"
"/posts/1797"
"/posts/3376"
"/@lindsay"
"/@violet"
"/image/1855.jpg"
"/image/6059.jpg"
"/posts/7627"
...
||<

<code>/posts/\d+</code> ã¨ <code>/images/.+</code> ã¨ <code>/@[a-zA-Z0-9]+</code> ã¿ãŸã„ãªã®ãŒæ²¢å±±ã‚ã‚Šãã†ã§ã™ã­ã€‚ <code>config.toml</code> ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã®è¨­å®šã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚ ãƒªãƒã‚¸ãƒˆãƒªã«ã‚‚ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚((è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ kataribe ã¨åŒã˜ã‚ˆã†ãªå½¢å¼ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ğŸ™))
[https://github.com/stefafafan/seki/blob/0e21718c5ba378b118108b8e430684f83d38e264/config.toml.example:embed:cite]

>|sh|
$ vim config.toml
$ cat config.toml
[[grouping]]
regexp = '^/posts/\d+$'

[[grouping]]
regexp = '^/@[a-zA-Z0-9]+$'
name = '/@:username'

[[grouping]]
regexp = '^/image/.+'
||<

<code>regexp</code> ã«æ­£è¦è¡¨ç¾ã‚’æ›¸ãã¾ã™ã€‚ <code>name</code> ã®æŒ‡å®šã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã§ã™ãŒã€åå‰ã‚’ã¤ã‘ãŸã„ã¨ãã«æ›¸ã„ã¦ãŠãã¨URLãŒä¸¦ã‚“ã æ™‚ã«è¦‹ã‚„ã™ããªã‚Šã¾ã™ã€‚

ä»Šä¸€åº¦å…ˆã»ã©ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚ <code>seki</code> ã¯åŒã˜éšå±¤ã«ã‚ã‚‹ <code>config.toml</code> ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§èª­ã¿è¾¼ã¿ã¾ã™ãŒã€ <code>--config</code> ã§æ˜ç¤ºçš„ã«ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

>|sh|
$ sudo cat /var/log/nginx/access.log | seki | jq '.[] | .uri'
"/login"
"/posts"
"/"
"/@:username"
"/admin/banned"
"/image/.+"
"/comment"
"/initialize"
"/js/main.js"
"/register"
"/"
"/css/style.css"
"^/posts/\\d+$"
"/favicon.ico"
"/login"
"/js/timeago.min.js"
"/logout"
||<

ã„ã„æ„Ÿã˜ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ãŒã§ããŸã®ã§ã€ã‚ã¨ã¯å¥½ããªå½¢ã«åŠ å·¥ã—ã¦ãƒ™ãƒ³ãƒã®çµæœã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä»Šå›ã¯ <code>response_time.sum</code> é †ã«ã—ã¤ã¤ã€ <code>column</code> ã‚³ãƒãƒ³ãƒ‰ã§æ•´å½¢ã—ã¦å‡ºåŠ›ã—ã¦ã¿ã¾ã™ã€‚

>|sh|
$ sudo cat /var/log/nginx/access.log | seki | \
    jq -r "sort_by(-.response_time.sum) | \
        .[] | \
        [.method, \
        .uri, \
        .status_code.status_2xx, \
        .status_code.status_3xx, \
        .status_code.status_4xx, \
        .status_code.status_5xx, \
        .response_time.sum] | \
        @tsv" | column -t
GET   /                   3939  0      0    0  198.79800000000128
GET   /posts              1590  0      0    0  95.20300000000013
GET   ^/posts/\\d+$       2829  0      0    0  93.72100000000103
POST  /login              0     1872   0    0  78.4420000000002
GET   /@:username         482   0      0    0  40.025
GET   /login              694   0      0    0  19.445999999999984
POST  /                   0     162    162  0  17.529000000000003
GET   /image/.+           2977  90691  0    0  16.31000000000001
POST  /register           0     263    0    0  12.548999999999992
GET   /logout             0     347    0    0  9.674999999999988
POST  /comment            0     244    0    0  7.659999999999998
GET   /admin/banned       0     0      263  0  7.20899999999999
GET   /initialize         1     0      0    0  0.369
GET   /css/style.css      5504  0      0    0  0.0
GET   /js/timeago.min.js  5504  0      0    0  0.0
GET   /favicon.ico        5504  0      0    0  0.0
GET   /js/main.js         5504  0      0    0  0.0
||<

<code>GET /</code> ãŒé…ãã†ãªã®ã§ã€ã“ã“ã®æ”¹å–„ã‚’ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

** ä½œã£ã¦ã¿ã¦ã®æ„Ÿæƒ³

å½“åˆæ€ã£ã¦ã„ãŸã‚ˆã‚Šã‚‚ã‚µã‚¯ãƒƒã¨CLIãŒä½œã‚Œã¦ã‚ˆã‹ã£ãŸã€ [https://blog.stenyan.jp/entry/2024/11/08/204610:title] ã®æ™‚ã¨åŒæ§˜ã« [https://github.com/clap-rs/clap:title=clap-rs/clap] ãŒã‚„ã£ã±ã‚Šä¾¿åˆ©ãªã®ã¨ã€ãã‚Œä»¥å¤–ã«ã‚‚å„ç¨®ãƒã‚¤ãƒŠãƒªã®ç”¨æ„ã‚„ãƒªãƒªãƒ¼ã‚¹ã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ç¾¤ ([https://github.com/crate-ci/cargo-release:title=crate-ci/cargo-release] ã¨ [https://github.com/axodotdev/cargo-dist:title=axodotdev/cargo-dist]) ã‚‚ã¨ã¦ã‚‚åŠ©ã‹ã‚Šã¾ã—ãŸã€‚

ãã—ã¦å®Ÿè£…ã®éš›ã« alp ã®ã“ã¨æ”¹ã‚ã¦èª¿ã¹ã¦ã„ã¾ã—ãŸãŒã€[https://zenn.dev/tkuchiki/articles/how-to-use-alp-2:title=ã‚ã¡ã‚ƒãã¡ã‚ƒæ©Ÿèƒ½å……å®Ÿã—ã¦ã„ã¦]ã™ã”ã„ãªã¨æ€ã£ãŸã‚Šã—ã¾ã—ãŸã€‚å®Ÿè£…ã«ã‚ãŸã£ã¦alpã¨kataribeã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ã¨ã¦ã‚‚å‚è€ƒã«ã—ã¾ã—ãŸã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ™ è¤‡é›‘ãªjqã®ã‚¯ã‚¨ãƒªã‚’æ›¸ãã®ã¯å¤§å¤‰ãªã®ã§ã“ã‚Œã‚‰æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã®ãŒä¸€ç•ªæ‰‹ã£å–ã‚Šæ—©ã„ãªã¨æ”¹ã‚ã¦æ€ã„ã¾ã—ãŸï¼ˆãŒè‡ªåˆ†ã§ã‚‚ä½œã‚‹ã®ã¯æ¥½ã—ã‹ã£ãŸã§ã™ï¼‰ã€‚

æ¬¡ã¯ [https://docs.percona.com/percona-toolkit/pt-query-digest.html:title=pt-query-digest] ä»£ã‚ã‚Šã®CLIã‚‚ä½œã‚ŠãŸã„ã§ã™ (?)ã€‚
